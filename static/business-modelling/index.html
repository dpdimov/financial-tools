<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Model Canvas to Financial Model</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../shared.css">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --accent-light: #ff6b88;
            --surface: #f8f9fa;
            --text: #2d3436;
            --text-light: #636e72;
            --border: #dfe6e9;
            --success: #00b894;
            --warning: #fdcb6e;
            --resource-bg: #d4edda;
            --resource-border: #28a745;
            --partnership-bg: #d1ecf1;
            --partnership-border: #17a2b8;
            --market-interface: #6c5ce7;
            --operational: #00b894;
            --financial: #e94560;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            font-weight: 300;
        }

        /* Interactive Diagram */
        .model-diagram {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .diagram-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .diagram-top-row {
            display: flex;
            gap: 3rem;
            justify-content: center;
            align-items: flex-start;
        }

        .diagram-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .diagram-box {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 180px;
            border: 2px solid transparent;
        }

        .diagram-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .diagram-box.active {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .diagram-market {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
        }

        .diagram-operational {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
        }

        .diagram-arrow {
            color: var(--text-light);
            font-size: 1.5rem;
        }

        .diagram-connector {
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 300;
            align-self: flex-start;
            margin-top: 1rem;
        }

        .diagram-inner-connector {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            font-weight: 300;
        }

        .diagram-financial-container {
            background: linear-gradient(135deg, var(--accent-light), var(--accent));
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .diagram-financial-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .diagram-financial-container.active {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .diagram-financial-title {
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .diagram-financial-inner {
            display: flex;
            gap: 1rem;
        }

        .diagram-inner-box {
            background: rgba(255, 255, 255, 0.9);
            color: var(--accent);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .diagram-inner-box:hover {
            background: white;
            transform: scale(1.05);
        }

        .diagram-inner-box.revenue {
            color: var(--market-interface);
        }

        .diagram-inner-box.cost {
            color: var(--operational);
        }

        .diagram-description {
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-light);
            text-align: center;
            line-height: 1.5;
        }

        .diagram-description strong {
            color: var(--text);
        }

        /* Print Buttons */
        .print-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .btn-print {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-print:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .model-diagram {
                box-shadow: none;
                border: 1px solid var(--border);
                page-break-after: always;
            }

            .print-buttons,
            .btn-primary,
            .btn-add,
            .btn-remove,
            .remove-card-btn,
            .add-popover-wrapper {
                display: none !important;
            }

            .section {
                box-shadow: none;
                border: 1px solid var(--border);
                page-break-inside: avoid;
            }

            .card {
                page-break-inside: avoid;
            }

            .card-title-input {
                border: none;
                background: transparent;
            }

            input, select {
                border: none !important;
                background: transparent !important;
            }

            /* Hide sections when printing only financial model */
            body.print-financial-only .model-diagram,
            body.print-financial-only .market-interface,
            body.print-financial-only .operational-infrastructure {
                display: none !important;
            }

            body.print-financial-only .financial-model {
                margin-top: 0;
            }
        }

        /* Section Styles */
        .section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--border);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--primary);
        }

        .section.market-interface .section-header {
            border-color: var(--market-interface);
        }

        .section.operational-infrastructure .section-header {
            border-color: var(--operational);
        }

        .section.financial-model .section-header {
            border-color: var(--financial);
        }

        /* Card Styles */
        .card {
            background: var(--surface);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 2px solid var(--border);
            transition: border-color 0.3s ease;
        }

        .card:hover {
            border-color: #b2bec3;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title-input {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            border: none;
            background: transparent;
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .card-title-input:focus {
            outline: none;
            background: white;
        }

        .card-title-input:read-only {
            cursor: default;
        }

        /* Nested Items */
        .nested-section {
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 2px solid var(--border);
            margin-top: 0.75rem;
        }

        .nested-item {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .nested-item-header {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .nested-item-header input {
            flex: 1;
            min-width: 150px;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .nested-item-header select {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            background: white;
        }

        .nested-item-header input:focus,
        .nested-item-header select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-source-market {
            background: #e0d5f7;
            color: var(--market-interface);
        }

        .badge-source-manual {
            background: #dfe6e9;
            color: var(--text-light);
        }

        .badge-shared {
            background: #ffeaa7;
            color: #e17055;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
        }

        .badge-subscription { background: #b2fef7; color: #00cec9; }
        .badge-contract { background: #a29bfe; color: #6c5ce7; }
        .badge-item-sold { background: #ffeaa7; color: #d68910; }
        .badge-usage { background: #fab1a0; color: #e17055; }
        .badge-sales { background: #74b9ff; color: #0984e3; }
        .badge-marketing { background: #ffd7e5; color: #fd79a8; }
        .badge-resource { background: var(--resource-bg); color: var(--resource-border); }
        .badge-partnership { background: var(--partnership-bg); color: var(--partnership-border); }
        .badge-fixed { background: #d6d8db; color: #495057; }
        .badge-variable { background: #ffeaa7; color: #d63031; }
        .badge-direct { background: #dfe6e9; color: #2d3436; }
        .badge-indirect { background: #fab1a0; color: #e17055; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);
        }

        .btn-add {
            background: white;
            color: var(--text);
            border: 2px dashed var(--border);
        }

        .btn-add:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: #fff5f7;
        }

        .btn-remove {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            transition: transform 0.2s ease;
        }

        .btn-remove:hover {
            transform: scale(1.2);
        }

        .remove-card-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .remove-card-btn:hover {
            background: var(--accent-light);
        }

        /* Popover */
        .add-popover-wrapper {
            position: relative;
            display: inline-block;
        }

        .add-popover {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            z-index: 1000;
        }

        .add-popover-create {
            padding: 0.6rem 1rem;
            font-weight: 600;
            color: var(--accent);
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            transition: background 0.15s;
        }

        .add-popover-create:hover {
            background: #fff5f7;
        }

        .add-popover-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .add-popover-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }

        .add-popover-item:hover {
            background: var(--surface);
        }

        .add-popover-item .usage-count {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-left: 0.5rem;
        }

        .add-popover-empty {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Tree View */
        .tree-view {
            font-size: 0.95rem;
        }

        .tree-section {
            margin-bottom: 1.5rem;
        }

        .tree-section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .tree-node {
            position: relative;
            padding-left: 1.5rem;
        }

        .tree-node::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--border);
        }

        .tree-node::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0.75rem;
            width: 1rem;
            height: 1px;
            background: var(--border);
        }

        .tree-node:last-child::before {
            height: 0.75rem;
        }

        .tree-item {
            padding: 0.4rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tree-item-name {
            font-weight: 500;
        }

        .tree-children {
            margin-left: 0.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            font-style: italic;
        }

        /* Resource Row */
        .resource-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background: var(--surface);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        .resource-row.resource-type {
            border-left: 3px solid var(--resource-border);
        }

        .resource-row.partnership-type {
            border-left: 3px solid var(--partnership-border);
        }

        .resource-row input,
        .resource-row select {
            padding: 0.4rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.85rem;
            background: white;
        }

        .resource-row input:focus,
        .resource-row select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .resource-row input[type="text"] {
            flex: 1;
            min-width: 120px;
        }

        /* Section Label */
        .section-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }

        .section-label:first-child {
            margin-top: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .section {
                padding: 1.25rem;
            }

            .diagram-top-row {
                flex-direction: column;
                gap: 0.25rem;
            }

            .diagram-column {
                width: 100%;
            }

            .diagram-box {
                min-width: unset;
                width: 100%;
            }

            .diagram-connector {
                align-self: center;
                margin-top: 0;
            }

            .diagram-financial-container {
                width: 100%;
            }

            .diagram-financial-inner {
                flex-direction: column;
                gap: 0.25rem;
                width: 100%;
            }

            .diagram-inner-box {
                width: 100%;
                text-align: center;
            }

            .nested-item-header {
                flex-direction: column;
                align-items: stretch;
            }

            .nested-item-header input,
            .nested-item-header select {
                width: 100%;
            }

            .resource-row {
                flex-direction: column;
                align-items: stretch;
            }

            .resource-row input,
            .resource-row select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="site-nav">
        <div class="nav-container">
            <a href="../" class="nav-brand">Financial Tools</a>
            <ul class="nav-links">
                <li><a href="../">Home</a></li>
                <li><a href="../business-modelling/" class="active">Business Model</a></li>
                <li><a href="../cash-management/">Cash Flow</a></li>
                <li><a href="../financial-engine/">Financial Engine</a></li>
                <li><a href="../risk-visualizer/">Risk Visualizer</a></li>
                <li><a href="../cap-table/">Cap Table</a></li>
                <li><a href="../j-curve-explorer/">J-Curve</a></li>
                <li><a href="../j-curve-fund/">Fund J-Curve</a></li>
                <li><a href="../market-projection/">Market Sizing</a></li>
                <li><a href="../vc-valuation/">VC Valuation</a></li>
                <li><a href="../ltv-analyzer/">LTV Analyzer</a></li>
                <li><a href="../cac-analyzer/">CAC Analyzer</a></li>
                <li><a href="../glossary/">Glossary</a></li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <header>
            <h1>Business Model Design</h1>
            <p class="subtitle">Map your business structure to enable financial modelling</p>
        </header>

        <!-- Interactive Diagram -->
        <div class="model-diagram">
            <div class="diagram-container">
                <div class="diagram-top-row">
                    <div class="diagram-column">
                        <div class="diagram-box diagram-market" id="nav-market" onclick="scrollToSection('market-interface')">
                            Market Interface
                        </div>
                        <span class="diagram-arrow">&#8595;</span>
                    </div>
                    <span class="diagram-connector">+</span>
                    <div class="diagram-column">
                        <div class="diagram-box diagram-operational" id="nav-operational" onclick="scrollToSection('operational-infrastructure')">
                            Operational Infrastructure
                        </div>
                        <span class="diagram-arrow">&#8595;</span>
                    </div>
                </div>
                <div class="diagram-financial-container" id="nav-financial" onclick="scrollToSection('financial-model')">
                    <div class="diagram-financial-title">Financial Model</div>
                    <div class="diagram-financial-inner">
                        <div class="diagram-inner-box revenue">Revenue Streams</div>
                        <span class="diagram-inner-connector">+</span>
                        <div class="diagram-inner-box cost">Cost Structure</div>
                    </div>
                </div>
            </div>
            <p class="diagram-description">Define your customer types, revenue streams, and sales/marketing activities in <strong>Market Interface</strong>. Add operational activities with their resources and partnerships in <strong>Operational Infrastructure</strong>. The <strong>Financial Model Architecture</strong> sets the stage for building your financial model.</p>
            <div class="print-buttons">
                <button class="btn-print" onclick="printAll()">Print Entire Design</button>
                <button class="btn-print" onclick="printFinancialModel()">Print Financial Model</button>
                <button class="btn-print" onclick="resetAll()" style="color: var(--accent);">Reset All</button>
            </div>
        </div>

        <!-- Market Interface Section -->
        <section class="section market-interface" id="market-interface">
            <div class="section-header">
                <h2 class="section-title">Market Interface</h2>
                <button class="btn btn-primary" onclick="addCustomerType()">+ Customer Type</button>
            </div>
            <div id="customer-types-container">
                <div class="empty-state">Add customer types to define your revenue-generating structure</div>
            </div>
        </section>

        <!-- Operational Infrastructure Section -->
        <section class="section operational-infrastructure" id="operational-infrastructure">
            <div class="section-header">
                <h2 class="section-title">Operational Infrastructure</h2>
                <button class="btn btn-primary" onclick="addManualActivity()">+ Activity</button>
            </div>
            <div id="activities-container">
                <div class="empty-state">Activities will appear here from Market Interface, or add your own</div>
            </div>
        </section>

        <!-- Financial Model Section -->
        <section class="section financial-model" id="financial-model">
            <div class="section-header">
                <h2 class="section-title">Financial Model Architecture</h2>
            </div>
            <div class="tree-view" id="financial-tree">
                <div class="empty-state">Your revenue and cost structure will appear here</div>
            </div>
        </section>
    </div>

    <script>
        // ==================== DATA MODEL ====================

        let marketInterface = {
            customerTypes: []
        };

        let operationalInfrastructure = {
            activities: []
        };

        // Registries: shared items live here, referenced by ID elsewhere
        let registries = {
            channels: {},      // id -> { id, name }
            activities: {},    // id -> { id, name, type }
            resources: {}      // id -> { id, name, type, behavior, classification }
        };

        // channelId -> [activityId, ...]
        let channelActivities = {};

        let counters = {
            customerType: 0,
            revenue: 0,
            channel: 0,
            activity: 0,
            resource: 0
        };

        // ==================== REGISTRY HELPERS ====================

        function getChannel(id) { return registries.channels[id] || null; }
        function getActivity(id) { return registries.activities[id] || null; }
        function getResource(id) { return registries.resources[id] || null; }

        function getAllChannels() { return Object.values(registries.channels); }
        function getAllActivities() { return Object.values(registries.activities); }
        function getAllResources() { return Object.values(registries.resources); }

        function channelUsageCount(channelId) {
            let count = 0;
            marketInterface.customerTypes.forEach(ct => {
                ct.revenues.forEach(rev => {
                    if (rev.channelIds.includes(channelId)) count++;
                });
            });
            return count;
        }

        function activityUsageCount(activityId) {
            let count = 0;
            Object.values(channelActivities).forEach(ids => {
                if (ids.includes(activityId)) count++;
            });
            return count;
        }

        function resourceUsageCount(resourceId) {
            let count = 0;
            operationalInfrastructure.activities.forEach(act => {
                if (act.resourceIds.includes(resourceId)) count++;
            });
            return count;
        }

        function isChannelShared(channelId) { return channelUsageCount(channelId) > 1; }
        function isActivityShared(activityId) { return activityUsageCount(activityId) > 1; }
        function isResourceShared(resourceId) { return resourceUsageCount(resourceId) > 1; }

        function sharedBadgeHtml(isShared) {
            return isShared ? ' <span class="badge badge-shared">shared</span>' : '';
        }

        // ==================== POPOVER ====================

        let activePopoverId = null;

        function toggleAddPopover(popoverId, evt) {
            evt.stopPropagation();
            const el = document.getElementById(popoverId);
            if (!el) return;
            if (activePopoverId === popoverId) {
                closeAllPopovers();
            } else {
                closeAllPopovers();
                el.style.display = 'block';
                activePopoverId = popoverId;
            }
        }

        function closeAllPopovers() {
            document.querySelectorAll('.add-popover').forEach(p => p.style.display = 'none');
            activePopoverId = null;
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.add-popover-wrapper')) {
                closeAllPopovers();
            }
        });

        function renderChannelPopover(popoverId, ctId, rev) {
            const existingIds = rev.channelIds || [];
            const available = getAllChannels().filter(ch => !existingIds.includes(ch.id));
            let html = `<div class="add-popover" id="${popoverId}" style="display:none;">`;
            html += `<div class="add-popover-create" onclick="createAndLinkChannel(${ctId}, ${rev.id})">+ Create New</div>`;
            if (available.length > 0) {
                html += '<div class="add-popover-list">';
                available.forEach(ch => {
                    const usage = channelUsageCount(ch.id);
                    html += `<div class="add-popover-item" onclick="linkChannel(${ctId}, ${rev.id}, ${ch.id})">
                        <span>${escHtml(ch.name || 'Unnamed')}</span>
                        ${usage > 0 ? `<span class="usage-count">used ${usage}x</span>` : ''}
                    </div>`;
                });
                html += '</div>';
            } else {
                html += '<div class="add-popover-empty">No other channels available</div>';
            }
            html += '</div>';
            return html;
        }

        function renderActivityPopover(popoverId, channelId) {
            const existingIds = channelActivities[channelId] || [];
            const available = getAllActivities().filter(a => !existingIds.includes(a.id));
            let html = `<div class="add-popover" id="${popoverId}" style="display:none;">`;
            html += `<div class="add-popover-create" onclick="createAndLinkActivity(${channelId})">+ Create New</div>`;
            if (available.length > 0) {
                html += '<div class="add-popover-list">';
                available.forEach(act => {
                    const usage = activityUsageCount(act.id);
                    html += `<div class="add-popover-item" onclick="linkActivityToChannel(${channelId}, ${act.id})">
                        <span>${escHtml(act.name || 'Unnamed')}</span>
                        ${usage > 0 ? `<span class="usage-count">used ${usage}x</span>` : ''}
                    </div>`;
                });
                html += '</div>';
            } else {
                html += '<div class="add-popover-empty">No other activities available</div>';
            }
            html += '</div>';
            return html;
        }

        function renderResourcePopover(popoverId, oiAct) {
            const existingIds = oiAct.resourceIds || [];
            const available = getAllResources().filter(r => !existingIds.includes(r.id));
            let html = `<div class="add-popover" id="${popoverId}" style="display:none;">`;
            html += `<div class="add-popover-create" onclick="createAndLinkResource(${JSON.stringify(oiAct.id)})">+ Create New</div>`;
            if (available.length > 0) {
                html += '<div class="add-popover-list">';
                available.forEach(res => {
                    const usage = resourceUsageCount(res.id);
                    html += `<div class="add-popover-item" onclick="linkResource(${JSON.stringify(oiAct.id)}, ${res.id})">
                        <span>${escHtml(res.name || 'Unnamed')}</span>
                        ${usage > 0 ? `<span class="usage-count">used ${usage}x</span>` : ''}
                    </div>`;
                });
                html += '</div>';
            } else {
                html += '<div class="add-popover-empty">No other resources available</div>';
            }
            html += '</div>';
            return html;
        }

        function escHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // ==================== CHANNEL CRUD ====================

        function createAndLinkChannel(customerTypeId, revenueId) {
            closeAllPopovers();
            counters.channel++;
            const id = counters.channel;
            registries.channels[id] = { id, name: '' };
            linkChannel(customerTypeId, revenueId, id);
        }

        function linkChannel(customerTypeId, revenueId, channelId) {
            closeAllPopovers();
            const ct = marketInterface.customerTypes.find(c => c.id === customerTypeId);
            if (ct) {
                const rev = ct.revenues.find(r => r.id === revenueId);
                if (rev && !rev.channelIds.includes(channelId)) {
                    rev.channelIds.push(channelId);
                    if (!channelActivities[channelId]) {
                        channelActivities[channelId] = [];
                    }
                }
            }
            syncActivitiesFromMarketInterface();
            renderAll();
            saveState();
        }

        function unlinkChannel(customerTypeId, revenueId, channelId) {
            const ct = marketInterface.customerTypes.find(c => c.id === customerTypeId);
            if (ct) {
                const rev = ct.revenues.find(r => r.id === revenueId);
                if (rev) {
                    rev.channelIds = rev.channelIds.filter(id => id !== channelId);
                }
            }
            syncActivitiesFromMarketInterface();
            renderAll();
            saveState();
        }

        function updateChannel(channelId, field, value) {
            const ch = registries.channels[channelId];
            if (ch) {
                ch[field] = value;
                renderAll();
                saveState();
            }
        }

        // ==================== ACTIVITY CRUD ====================

        function createAndLinkActivity(channelId) {
            closeAllPopovers();
            counters.activity++;
            const id = counters.activity;
            registries.activities[id] = { id, name: '', type: 'sales' };
            linkActivityToChannel(channelId, id);
        }

        function linkActivityToChannel(channelId, activityId) {
            closeAllPopovers();
            if (!channelActivities[channelId]) {
                channelActivities[channelId] = [];
            }
            if (!channelActivities[channelId].includes(activityId)) {
                channelActivities[channelId].push(activityId);
            }
            syncActivitiesFromMarketInterface();
            renderAll();
            saveState();
        }

        function unlinkActivityFromChannel(channelId, activityId) {
            if (channelActivities[channelId]) {
                channelActivities[channelId] = channelActivities[channelId].filter(id => id !== activityId);
            }
            syncActivitiesFromMarketInterface();
            renderAll();
            saveState();
        }

        function updateActivity(activityId, field, value) {
            const act = registries.activities[activityId];
            if (act) {
                act[field] = value;
                syncActivitiesFromMarketInterface();
                renderAll();
                saveState();
            }
        }

        // ==================== RESOURCE CRUD ====================

        function createAndLinkResource(activityOiId) {
            closeAllPopovers();
            counters.resource++;
            const id = counters.resource;
            registries.resources[id] = { id, name: '', type: 'resource', behavior: 'fixed', classification: 'direct' };
            linkResource(activityOiId, id);
        }

        function linkResource(activityOiId, resourceId) {
            closeAllPopovers();
            const act = operationalInfrastructure.activities.find(a => a.id === activityOiId);
            if (act && !act.resourceIds.includes(resourceId)) {
                act.resourceIds.push(resourceId);
            }
            renderAll();
            saveState();
        }

        function unlinkResource(activityOiId, resourceId) {
            const act = operationalInfrastructure.activities.find(a => a.id === activityOiId);
            if (act) {
                act.resourceIds = act.resourceIds.filter(id => id !== resourceId);
            }
            renderAll();
            saveState();
        }

        function updateResource(resourceId, field, value) {
            const res = registries.resources[resourceId];
            if (res) {
                res[field] = value;
                renderAll();
                saveState();
            }
        }

        // ==================== MARKET INTERFACE ====================

        function addCustomerType() {
            counters.customerType++;
            marketInterface.customerTypes.push({
                id: counters.customerType,
                name: `Customer Type ${counters.customerType}`,
                revenues: []
            });
            renderMarketInterface();
            saveState();
        }

        function removeCustomerType(id) {
            const ct = marketInterface.customerTypes.find(c => c.id === id);
            if (ct) {
                // Unlink channels from all revenues (channels stay in registry)
                ct.revenues.forEach(rev => {
                    rev.channelIds = [];
                });
            }
            marketInterface.customerTypes = marketInterface.customerTypes.filter(ct => ct.id !== id);
            syncActivitiesFromMarketInterface();
            renderAll();
            saveState();
        }

        function updateCustomerTypeName(id, name) {
            const ct = marketInterface.customerTypes.find(c => c.id === id);
            if (ct) {
                ct.name = name;
                renderFinancialModel();
                saveState();
            }
        }

        function addRevenue(customerTypeId) {
            const ct = marketInterface.customerTypes.find(c => c.id === customerTypeId);
            if (ct) {
                counters.revenue++;
                ct.revenues.push({
                    id: counters.revenue,
                    name: '',
                    type: 'subscription',
                    channelIds: []
                });
                renderMarketInterface();
                saveState();
            }
        }

        function removeRevenue(customerTypeId, revenueId) {
            const ct = marketInterface.customerTypes.find(c => c.id === customerTypeId);
            if (ct) {
                ct.revenues = ct.revenues.filter(r => r.id !== revenueId);
                syncActivitiesFromMarketInterface();
                renderAll();
                saveState();
            }
        }

        function updateRevenue(customerTypeId, revenueId, field, value) {
            const ct = marketInterface.customerTypes.find(c => c.id === customerTypeId);
            if (ct) {
                const rev = ct.revenues.find(r => r.id === revenueId);
                if (rev) {
                    rev[field] = value;
                    renderFinancialModel();
                    saveState();
                }
            }
        }

        // ==================== OPERATIONAL INFRASTRUCTURE ====================

        function syncActivitiesFromMarketInterface() {
            // Collect all unique activity IDs referenced across all channels
            const miActivityIds = new Set();
            // Walk all revenues -> channelIds -> channelActivities
            marketInterface.customerTypes.forEach(ct => {
                ct.revenues.forEach(rev => {
                    (rev.channelIds || []).forEach(chId => {
                        (channelActivities[chId] || []).forEach(actId => {
                            if (registries.activities[actId] && registries.activities[actId].name) {
                                miActivityIds.add(actId);
                            }
                        });
                    });
                });
            });

            // Remove MI-sourced OI activities whose sourceRef is no longer in miActivityIds
            operationalInfrastructure.activities = operationalInfrastructure.activities.filter(act => {
                if (act.source === 'manual') return true;
                return miActivityIds.has(act.sourceRef);
            });

            // Add or update MI activities
            miActivityIds.forEach(actId => {
                const regAct = registries.activities[actId];
                if (!regAct) return;
                const existing = operationalInfrastructure.activities.find(
                    act => act.source === 'market-interface' && act.sourceRef === actId
                );
                if (existing) {
                    existing.name = regAct.name;
                    existing.activityType = regAct.type;
                } else {
                    operationalInfrastructure.activities.push({
                        id: Date.now() + Math.random(),
                        name: regAct.name,
                        activityType: regAct.type,
                        source: 'market-interface',
                        sourceRef: actId,
                        resourceIds: []
                    });
                }
            });
        }

        function addManualActivity() {
            counters.activity++;
            operationalInfrastructure.activities.push({
                id: Date.now(),
                name: `Activity ${counters.activity}`,
                activityType: 'operational',
                source: 'manual',
                sourceRef: null,
                resourceIds: []
            });
            renderOperationalInfrastructure();
            saveState();
        }

        function removeActivity(activityId) {
            operationalInfrastructure.activities = operationalInfrastructure.activities.filter(
                a => a.id !== activityId
            );
            renderAll();
            saveState();
        }

        function updateActivityName(activityId, name) {
            const act = operationalInfrastructure.activities.find(a => a.id === activityId);
            if (act && act.source === 'manual') {
                act.name = name;
                renderFinancialModel();
                saveState();
            }
        }

        // ==================== RENDERING ====================

        function renderMarketInterface() {
            const container = document.getElementById('customer-types-container');

            if (marketInterface.customerTypes.length === 0) {
                container.innerHTML = '<div class="empty-state">Add customer types to define your revenue-generating structure</div>';
                return;
            }

            container.innerHTML = marketInterface.customerTypes.map(ct => `
                <div class="card">
                    <div class="card-header">
                        <input type="text" class="card-title-input" value="${escHtml(ct.name)}"
                            onchange="updateCustomerTypeName(${ct.id}, this.value)"
                            placeholder="Customer type name...">
                        <button class="remove-card-btn" onclick="removeCustomerType(${ct.id})">Remove</button>
                    </div>

                    <div class="section-label">Revenue Streams</div>
                    <div class="nested-section">
                        ${ct.revenues.map(rev => {
                            const chPopId = `ch-pop-${ct.id}-${rev.id}`;
                            return `
                            <div class="nested-item">
                                <div class="nested-item-header">
                                    <input type="text" placeholder="Revenue stream name" value="${escHtml(rev.name)}"
                                        onchange="updateRevenue(${ct.id}, ${rev.id}, 'name', this.value)">
                                    <select onchange="updateRevenue(${ct.id}, ${rev.id}, 'type', this.value)">
                                        <option value="subscription" ${rev.type === 'subscription' ? 'selected' : ''}>Subscription</option>
                                        <option value="contract" ${rev.type === 'contract' ? 'selected' : ''}>Contract</option>
                                        <option value="item-sold" ${rev.type === 'item-sold' ? 'selected' : ''}>Item Sold</option>
                                        <option value="usage" ${rev.type === 'usage' ? 'selected' : ''}>Usage-based</option>
                                    </select>
                                    <button class="btn-remove" onclick="removeRevenue(${ct.id}, ${rev.id})">&#215;</button>
                                </div>

                                <div class="section-label" style="font-size: 0.8rem;">Channels</div>
                                <div class="nested-section">
                                    ${(rev.channelIds || []).map(chId => {
                                        const ch = getChannel(chId);
                                        if (!ch) return '';
                                        const shared = isChannelShared(chId);
                                        const actPopId = `act-pop-${chId}-${rev.id}`;
                                        return `
                                        <div class="nested-item" style="background: #f8f9fa;">
                                            <div class="nested-item-header">
                                                <input type="text" placeholder="Channel name" value="${escHtml(ch.name)}"
                                                    onchange="updateChannel(${ch.id}, 'name', this.value)">
                                                ${sharedBadgeHtml(shared)}
                                                <button class="btn-remove" onclick="unlinkChannel(${ct.id}, ${rev.id}, ${ch.id})">&#215;</button>
                                            </div>

                                            <div class="section-label" style="font-size: 0.75rem;">Activities</div>
                                            ${(channelActivities[chId] || []).map(actId => {
                                                const act = getActivity(actId);
                                                if (!act) return '';
                                                const actShared = isActivityShared(actId);
                                                return `
                                                <div class="resource-row ${act.type}-type" style="border-left-color: ${act.type === 'sales' ? '#0984e3' : '#fd79a8'};">
                                                    <input type="text" placeholder="Activity name" value="${escHtml(act.name)}"
                                                        onchange="updateActivity(${act.id}, 'name', this.value)">
                                                    <select onchange="updateActivity(${act.id}, 'type', this.value)">
                                                        <option value="sales" ${act.type === 'sales' ? 'selected' : ''}>Sales</option>
                                                        <option value="marketing" ${act.type === 'marketing' ? 'selected' : ''}>Marketing</option>
                                                    </select>
                                                    ${sharedBadgeHtml(actShared)}
                                                    <button class="btn-remove" onclick="unlinkActivityFromChannel(${ch.id}, ${act.id})">&#215;</button>
                                                </div>`;
                                            }).join('')}
                                            <div class="add-popover-wrapper">
                                                <button class="btn btn-add" style="font-size: 0.8rem; padding: 0.3rem 0.6rem; margin-top: 0.25rem;"
                                                    onclick="toggleAddPopover('${actPopId}', event)">+ Activity</button>
                                                ${renderActivityPopover(actPopId, chId)}
                                            </div>
                                        </div>`;
                                    }).join('')}
                                    <div class="add-popover-wrapper">
                                        <button class="btn btn-add" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"
                                            onclick="toggleAddPopover('${chPopId}', event)">+ Channel</button>
                                        ${renderChannelPopover(chPopId, ct.id, rev)}
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                        <button class="btn btn-add" onclick="addRevenue(${ct.id})">+ Revenue Stream</button>
                    </div>
                </div>
            `).join('');
        }

        function renderOperationalInfrastructure() {
            const container = document.getElementById('activities-container');

            if (operationalInfrastructure.activities.length === 0) {
                container.innerHTML = '<div class="empty-state">Activities will appear here from Market Interface, or add your own</div>';
                return;
            }

            container.innerHTML = operationalInfrastructure.activities.map(act => {
                const resPopId = `res-pop-${act.id}`;
                return `
                <div class="card">
                    <div class="card-header">
                        <input type="text" class="card-title-input" value="${escHtml(act.name)}"
                            ${act.source === 'market-interface' ? 'readonly' : ''}
                            onchange="updateActivityName(${JSON.stringify(act.id)}, this.value)"
                            placeholder="Activity name...">
                        <span class="badge ${act.source === 'market-interface' ? 'badge-source-market' : 'badge-source-manual'}">
                            ${act.source === 'market-interface' ? 'Market Interface' : 'Manual'}
                        </span>
                        ${act.source === 'manual' ? `<button class="remove-card-btn" onclick="removeActivity(${JSON.stringify(act.id)})">Remove</button>` : ''}
                    </div>

                    <div class="section-label">Resources & Partnerships</div>
                    ${(act.resourceIds || []).map(resId => {
                        const res = getResource(resId);
                        if (!res) return '';
                        const shared = isResourceShared(resId);
                        return `
                        <div class="resource-row ${res.type}-type">
                            <input type="text" placeholder="Name" value="${escHtml(res.name)}"
                                onchange="updateResource(${res.id}, 'name', this.value)">
                            <select onchange="updateResource(${res.id}, 'type', this.value)">
                                <option value="resource" ${res.type === 'resource' ? 'selected' : ''}>Resource</option>
                                <option value="partnership" ${res.type === 'partnership' ? 'selected' : ''}>Partnership</option>
                            </select>
                            <select onchange="updateResource(${res.id}, 'behavior', this.value)">
                                <option value="fixed" ${res.behavior === 'fixed' ? 'selected' : ''}>Fixed</option>
                                <option value="variable" ${res.behavior === 'variable' ? 'selected' : ''}>Variable</option>
                            </select>
                            <select onchange="updateResource(${res.id}, 'classification', this.value)">
                                <option value="direct" ${res.classification === 'direct' ? 'selected' : ''}>Direct</option>
                                <option value="indirect" ${res.classification === 'indirect' ? 'selected' : ''}>Indirect</option>
                            </select>
                            ${sharedBadgeHtml(shared)}
                            <button class="btn-remove" onclick="unlinkResource(${JSON.stringify(act.id)}, ${res.id})">&#215;</button>
                        </div>`;
                    }).join('')}
                    <div class="add-popover-wrapper">
                        <button class="btn btn-add" onclick="toggleAddPopover('${resPopId}', event)">+ Resource/Partnership</button>
                        ${renderResourcePopover(resPopId, act)}
                    </div>
                </div>`;
            }).join('');
        }

        function renderFinancialModel() {
            const container = document.getElementById('financial-tree');

            let hasContent = false;

            // Build revenue tree
            let revenueHtml = '<div class="tree-section"><div class="tree-section-title">Revenue Streams</div>';

            if (marketInterface.customerTypes.length === 0) {
                revenueHtml += '<div class="empty-state" style="padding: 1rem;">No customer types defined</div>';
            } else {
                marketInterface.customerTypes.forEach(ct => {
                    revenueHtml += `<div class="tree-node"><div class="tree-item"><span class="tree-item-name">${escHtml(ct.name || 'Unnamed Customer')}</span></div>`;
                    revenueHtml += '<div class="tree-children">';

                    ct.revenues.forEach(rev => {
                        hasContent = true;
                        revenueHtml += `
                            <div class="tree-node">
                                <div class="tree-item">
                                    <span class="badge badge-${rev.type}">${rev.type}</span>
                                    <span class="tree-item-name">${escHtml(rev.name || 'Unnamed Revenue')}</span>
                                </div>
                                <div class="tree-children">
                        `;

                        (rev.channelIds || []).forEach(chId => {
                            const ch = getChannel(chId);
                            if (!ch) return;
                            revenueHtml += `
                                <div class="tree-node">
                                    <div class="tree-item">
                                        <span class="tree-item-name">${escHtml(ch.name || 'Unnamed Channel')}</span>
                                        ${sharedBadgeHtml(isChannelShared(chId))}
                                    </div>
                                    <div class="tree-children">
                            `;

                            (channelActivities[chId] || []).forEach(actId => {
                                const act = getActivity(actId);
                                if (!act) return;
                                revenueHtml += `
                                    <div class="tree-node">
                                        <div class="tree-item">
                                            <span class="badge badge-${act.type}">${act.type}</span>
                                            <span class="tree-item-name">${escHtml(act.name || 'Unnamed Activity')}</span>
                                            ${sharedBadgeHtml(isActivityShared(actId))}
                                        </div>
                                    </div>
                                `;
                            });

                            revenueHtml += '</div></div>';
                        });

                        revenueHtml += '</div></div>';
                    });

                    revenueHtml += '</div></div>';
                });
            }

            revenueHtml += '</div>';

            // Build cost tree
            let costHtml = '<div class="tree-section"><div class="tree-section-title">Cost Structure</div>';

            if (operationalInfrastructure.activities.length === 0) {
                costHtml += '<div class="empty-state" style="padding: 1rem;">No activities defined</div>';
            } else {
                operationalInfrastructure.activities.forEach(act => {
                    if ((act.resourceIds || []).length === 0) return;
                    hasContent = true;

                    costHtml += `
                        <div class="tree-node">
                            <div class="tree-item">
                                <span class="badge ${act.source === 'market-interface' ? 'badge-source-market' : 'badge-source-manual'}">
                                    ${act.source === 'market-interface' ? 'MI' : 'Op'}
                                </span>
                                <span class="tree-item-name">${escHtml(act.name || 'Unnamed Activity')}</span>
                            </div>
                            <div class="tree-children">
                    `;

                    (act.resourceIds || []).forEach(resId => {
                        const res = getResource(resId);
                        if (!res) return;
                        costHtml += `
                            <div class="tree-node">
                                <div class="tree-item">
                                    <span class="badge badge-${res.type}">${res.type}</span>
                                    <span class="tree-item-name">${escHtml(res.name || 'Unnamed')}</span>
                                    <span class="badge badge-${res.behavior}">${res.behavior}</span>
                                    <span class="badge badge-${res.classification}">${res.classification}</span>
                                    ${sharedBadgeHtml(isResourceShared(resId))}
                                </div>
                            </div>
                        `;
                    });

                    costHtml += '</div></div>';
                });
            }

            costHtml += '</div>';

            if (!hasContent && marketInterface.customerTypes.length === 0 && operationalInfrastructure.activities.length === 0) {
                container.innerHTML = '<div class="empty-state">Your revenue and cost structure will appear here</div>';
            } else {
                container.innerHTML = revenueHtml + costHtml;
            }
        }

        function renderAll() {
            renderMarketInterface();
            renderOperationalInfrastructure();
            renderFinancialModel();
        }

        // ==================== NAVIGATION ====================

        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Intersection Observer for highlighting active section
        function setupIntersectionObserver() {
            const sections = ['market-interface', 'operational-infrastructure', 'financial-model'];
            const navBoxes = {
                'market-interface': document.getElementById('nav-market'),
                'operational-infrastructure': document.getElementById('nav-operational'),
                'financial-model': document.getElementById('nav-financial')
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const navBox = navBoxes[entry.target.id];
                    if (navBox) {
                        if (entry.isIntersecting) {
                            navBox.classList.add('active');
                        } else {
                            navBox.classList.remove('active');
                        }
                    }
                });
            }, { threshold: 0.3 });

            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) observer.observe(section);
            });
        }

        // ==================== DATA MIGRATION ====================

        function migrateV2toV3(state) {
            // Already migrated?
            if (state.registries) return state;

            const newRegistries = { channels: {}, activities: {}, resources: {} };
            const newChannelActivities = {};
            const newCounters = state.counters || { customerType: 0, revenue: 0, channel: 0, activity: 0, resource: 0 };

            const mi = state.marketInterface || { customerTypes: [] };
            const oi = state.operationalInfrastructure || { activities: [] };

            // Migrate Market Interface: channels and activities into registries
            mi.customerTypes.forEach(ct => {
                (ct.revenues || []).forEach(rev => {
                    const newChannelIds = [];
                    (rev.channels || []).forEach(ch => {
                        // Register channel
                        newRegistries.channels[ch.id] = { id: ch.id, name: ch.name || '' };
                        newChannelIds.push(ch.id);

                        // Ensure counter is up-to-date
                        if (ch.id > newCounters.channel) newCounters.channel = ch.id;

                        // Register activities for this channel
                        const actIds = [];
                        (ch.activities || []).forEach(act => {
                            newRegistries.activities[act.id] = { id: act.id, name: act.name || '', type: act.type || 'sales' };
                            actIds.push(act.id);
                            if (act.id > newCounters.activity) newCounters.activity = act.id;
                        });
                        newChannelActivities[ch.id] = actIds;
                    });

                    // Replace inline channels with ID array
                    rev.channelIds = newChannelIds;
                    delete rev.channels;
                });
            });

            // Migrate OI: resources into registries
            oi.activities.forEach(act => {
                const newResourceIds = [];
                (act.resources || []).forEach(res => {
                    // Ensure numeric id
                    const resId = typeof res.id === 'number' ? res.id : newCounters.resource + 1;
                    if (resId > newCounters.resource) newCounters.resource = resId;
                    newRegistries.resources[resId] = {
                        id: resId,
                        name: res.name || '',
                        type: res.type || 'resource',
                        behavior: res.behavior || 'fixed',
                        classification: res.classification || 'direct'
                    };
                    newResourceIds.push(resId);
                });
                act.resourceIds = newResourceIds;
                delete act.resources;
            });

            return {
                marketInterface: mi,
                operationalInfrastructure: oi,
                registries: newRegistries,
                channelActivities: newChannelActivities,
                counters: newCounters
            };
        }

        // ==================== PERSISTENCE ====================

        function saveState() {
            localStorage.setItem('businessModelV2', JSON.stringify({
                marketInterface,
                operationalInfrastructure,
                registries,
                channelActivities,
                counters
            }));
        }

        function loadState() {
            const saved = localStorage.getItem('businessModelV2');
            if (saved) {
                let state = JSON.parse(saved);

                // Migrate if needed
                state = migrateV2toV3(state);

                marketInterface = state.marketInterface || { customerTypes: [] };
                operationalInfrastructure = state.operationalInfrastructure || { activities: [] };
                registries = state.registries || { channels: {}, activities: {}, resources: {} };
                channelActivities = state.channelActivities || {};
                counters = state.counters || { customerType: 0, revenue: 0, channel: 0, activity: 0, resource: 0 };

                // Ensure all OI activities have resourceIds array
                operationalInfrastructure.activities.forEach(act => {
                    if (!act.resourceIds) act.resourceIds = [];
                });

                // Ensure all revenues have channelIds array
                marketInterface.customerTypes.forEach(ct => {
                    (ct.revenues || []).forEach(rev => {
                        if (!rev.channelIds) rev.channelIds = [];
                    });
                });

                // Re-save migrated state
                saveState();
            }
            renderAll();
        }

        // ==================== PRINTING ====================

        function printAll() {
            document.body.classList.remove('print-financial-only');
            window.print();
        }

        function printFinancialModel() {
            document.body.classList.add('print-financial-only');
            window.print();
            // Remove the class after printing dialog closes
            setTimeout(() => {
                document.body.classList.remove('print-financial-only');
            }, 1000);
        }

        function resetAll() {
            if (!confirm('This will delete all your business model data. Are you sure?')) return;
            localStorage.removeItem('businessModelV2');
            marketInterface = { customerTypes: [] };
            operationalInfrastructure = { activities: [] };
            registries = { channels: {}, activities: {}, resources: {} };
            channelActivities = {};
            counters = { customerType: 0, revenue: 0, channel: 0, activity: 0, resource: 0 };
            renderAll();
        }

        // ==================== INITIALIZE ====================

        loadState();
        setupIntersectionObserver();
    </script>
    <footer style="text-align: center; padding: 40px 20px; color: var(--text-secondary); font-size: 0.9rem; border-top: 1px solid var(--border-color); margin-top: 40px;">
        <p>Dimo Dimov | Entrepreneurial Finance Tools</p>
    </footer>
</body>
</html>
