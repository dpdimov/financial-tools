<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cap Table Analyzer - Financial Tools</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../shared.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151b24;
            --bg-tertiary: #1e2835;
            --accent-cap: #a855f7;
            --accent-profit: #4a9eff;
            --accent-success: #00d4aa;
            --accent-warning: #ffa726;
            --accent-danger: #ff5757;
            --text-primary: #e8edf2;
            --text-secondary: #8b95a5;
            --border-color: #2a3442;
            --input-bg: #1a2231;
        }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 40px; position: relative; }
        .header::after { content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 200px; height: 2px; background: linear-gradient(90deg, transparent, var(--accent-cap), transparent); }
        h1 { font-family: 'Crimson Pro', serif; font-size: 48px; font-weight: 700; margin-bottom: 12px; background: linear-gradient(135deg, var(--accent-cap), var(--accent-profit)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .subtitle { font-size: 14px; color: var(--text-secondary); letter-spacing: 2px; text-transform: uppercase; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px; margin-bottom: 24px; }
        .card-title { font-family: 'Crimson Pro', serif; font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-card { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .summary-card.purple { border-left: 3px solid var(--accent-cap); }
        .summary-card.green { border-left: 3px solid var(--accent-success); }
        .summary-card.blue { border-left: 3px solid var(--accent-profit); }
        .summary-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
        .summary-value { font-size: 1.75rem; font-weight: 600; color: var(--text-primary); }
        .summary-sub { font-size: 0.8rem; color: var(--text-secondary); }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input, .form-select { width: 100%; padding: 10px 14px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.95rem; font-family: inherit; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-cap); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent-cap); color: white; }
        .btn-primary:hover { background: #9333ea; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: transparent; color: var(--accent-danger); padding: 6px; }
        .btn-danger:hover { background: rgba(255, 87, 87, 0.1); }
        .round-item { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 12px; }
        .round-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .round-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .round-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: 0.9rem; }
        .round-detail-label { color: var(--text-secondary); }
        .round-detail-value { font-weight: 600; color: var(--text-primary); }
        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); }
        .tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; background: rgba(168, 85, 247, 0.15); color: var(--accent-cap); }
        .tag.green { background: rgba(0, 212, 170, 0.15); color: var(--accent-success); }
        .tag.orange { background: rgba(255, 167, 38, 0.15); color: var(--accent-warning); }
        .tag.gray { background: rgba(139, 149, 165, 0.15); color: var(--text-secondary); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); border: 2px dashed var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; }
        td { color: var(--text-primary); }
        .text-right { text-align: right; }
        .text-success { color: var(--accent-success); }
        .text-danger { color: var(--accent-danger); }
        .chart-container { height: 350px; margin-top: 20px; position: relative; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-family: 'Crimson Pro', serif; font-size: 1.25rem; font-weight: 600; }
        .modal-body { padding: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 16px 24px; border-top: 1px solid var(--border-color); }
        .section-title { font-weight: 600; color: var(--text-primary); margin: 24px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-primary); }
        .checkbox-label input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent-cap); }
        .hint { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
        .info-box { background: rgba(74, 158, 255, 0.1); border: 1px solid rgba(74, 158, 255, 0.3); border-radius: 8px; padding: 16px; margin-top: 24px; }
        .info-box-title { font-weight: 600; color: var(--accent-profit); margin-bottom: 8px; }
        .info-box p { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
        .insights { background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; padding: 20px; }
        .insights-title { font-weight: 600; color: var(--accent-cap); margin-bottom: 12px; }
        .insights ul { list-style: none; padding: 0; }
        .insights li { color: var(--text-secondary); font-size: 0.9rem; padding: 6px 0; padding-left: 16px; position: relative; }
        .insights li::before { content: '•'; position: absolute; left: 0; color: var(--accent-cap); }
        @media (max-width: 768px) { h1 { font-size: 32px; } .form-row { grid-template-columns: 1fr; } .summary-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="site-nav">
        <div class="nav-container">
            <a href="../" class="nav-brand">Financial Tools</a>
            <ul class="nav-links">
                <li><a href="../">Home</a></li>
                <li><a href="../business-modelling/">Business Model</a></li>
                <li><a href="../cash-management/">Cash Flow</a></li>
                <li><a href="../financial-engine/">Financial Engine</a></li>
                <li><a href="../risk-visualizer/">Risk Visualizer</a></li>
                <li><a href="./" class="active">Cap Table</a></li>
            </ul>
        </div>
    </nav>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const OwnershipChart = ({ data, shareholders, colors }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || data.length === 0) return;

                if (chartRef.current) chartRef.current.destroy();

                const datasets = shareholders.map(sh => ({
                    label: sh,
                    data: data.map(d => parseFloat(d[sh]) || 0),
                    borderColor: colors[sh] || '#6b7280',
                    backgroundColor: colors[sh] || '#6b7280',
                    tension: 0.3,
                    fill: false
                }));

                chartRef.current = new Chart(canvasRef.current, {
                    type: 'line',
                    data: { labels: data.map(d => d.stage), datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { min: 0, max: 100, grid: { color: '#2a3442' }, ticks: { color: '#8b95a5' } },
                            x: { grid: { color: '#2a3442' }, ticks: { color: '#8b95a5' } }
                        },
                        plugins: { legend: { labels: { color: '#e8edf2' } } }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, shareholders, colors]);

            return <canvas ref={canvasRef}></canvas>;
        };

        const ValuationChart = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || data.length === 0) return;

                if (chartRef.current) chartRef.current.destroy();

                chartRef.current = new Chart(canvasRef.current, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.stage),
                        datasets: [
                            { label: 'Valuation ($M)', data: data.map(d => d['Post-Money Valuation']), backgroundColor: '#00d4aa', yAxisID: 'y' },
                            { label: 'Share Price ($)', data: data.map(d => parseFloat(d['Share Price'])), borderColor: '#4a9eff', backgroundColor: '#4a9eff', type: 'line', yAxisID: 'y1', tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { position: 'left', grid: { color: '#2a3442' }, ticks: { color: '#8b95a5' }, title: { display: true, text: 'Valuation ($M)', color: '#8b95a5' } },
                            y1: { position: 'right', grid: { display: false }, ticks: { color: '#8b95a5' }, title: { display: true, text: 'Share Price ($)', color: '#8b95a5' } },
                            x: { grid: { color: '#2a3442' }, ticks: { color: '#8b95a5' } }
                        },
                        plugins: { legend: { labels: { color: '#e8edf2' } } }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data]);

            return <canvas ref={canvasRef}></canvas>;
        };

        const CapTableTool = () => {
            const [foundingShares, setFoundingShares] = useState(1000000);
            const [rounds, setRounds] = useState([]);
            const [showAddModal, setShowAddModal] = useState(false);
            const [editingIndex, setEditingIndex] = useState(null);
            const [exitValuation, setExitValuation] = useState(50000000);
            const [newRound, setNewRound] = useState({ name: '', investment: 0, preMoneyValuation: 0, optionPoolPct: 0, optionPoolTiming: 'post', liquidationPreference: 1, participating: false, participationCap: 3, antiDilution: 'none', proRataRights: true });

            const openAddModal = () => {
                const lastRound = rounds[rounds.length - 1];
                const lastPostMoney = lastRound ? (lastRound.preMoneyValuation + lastRound.investment) : foundingShares * 0.5;
                const roundNumber = rounds.length;
                let roundName = 'Seed';
                if (roundNumber === 0) roundName = 'Pre-Seed';
                else if (roundNumber > 1) roundName = `Series ${String.fromCharCode(64 + roundNumber - 1)}`;
                setNewRound({ name: roundName, investment: Math.round(lastPostMoney * 0.5), preMoneyValuation: Math.round(lastPostMoney * 2), optionPoolPct: 0, optionPoolTiming: 'post', liquidationPreference: 1, participating: false, participationCap: 3, antiDilution: 'none', proRataRights: true });
                setEditingIndex(null);
                setShowAddModal(true);
            };

            const openEditModal = (index) => { setNewRound({ ...rounds[index] }); setEditingIndex(index); setShowAddModal(true); };
            const closeModal = () => { setShowAddModal(false); setEditingIndex(null); };

            const saveRound = () => {
                if (!newRound.name || newRound.investment <= 0 || newRound.preMoneyValuation <= 0) { alert('Please fill in all required fields'); return; }
                if (editingIndex !== null) { const updated = [...rounds]; updated[editingIndex] = { ...newRound }; setRounds(updated); }
                else { setRounds([...rounds, { ...newRound }]); }
                closeModal();
            };

            const removeRound = (index) => setRounds(rounds.filter((_, i) => i !== index));

            const capTableData = useMemo(() => {
                const shareholders = { 'Founders': { shares: foundingShares, class: 'Common', invested: 0, preferences: {} }, 'Option Pool': { shares: 0, class: 'Options', invested: 0, preferences: {} } };
                const history = [];
                let totalShares = foundingShares;
                history.push({ stage: 'Founding', totalShares, sharePrice: 0, postMoneyValuation: 0, shareholders: JSON.parse(JSON.stringify(shareholders)), ownership: { 'Founders': 100, 'Option Pool': 0 }, roundDetails: null });

                rounds.forEach((round, roundIndex) => {
                    let preMoneyShares = totalShares;
                    let optionPoolShares = 0;
                    if (round.optionPoolPct > 0 && round.optionPoolTiming === 'pre') {
                        const poolFraction = round.optionPoolPct / 100;
                        optionPoolShares = (poolFraction * preMoneyShares) / (1 - poolFraction);
                        shareholders['Option Pool'].shares += optionPoolShares;
                        preMoneyShares += optionPoolShares;
                    }
                    const sharePrice = round.preMoneyValuation / preMoneyShares;
                    let newShares = round.investment / sharePrice;

                    const investorName = round.name;
                    if (!shareholders[investorName]) {
                        shareholders[investorName] = { shares: 0, class: 'Preferred', invested: 0, preferences: { liquidationPreference: round.liquidationPreference, participating: round.participating, participationCap: round.participationCap, antiDilution: round.antiDilution, proRataRights: round.proRataRights, originalPrice: sharePrice } };
                    }
                    shareholders[investorName].shares = newShares;
                    shareholders[investorName].invested = round.investment;

                    let postMoneyShares = preMoneyShares + newShares;
                    if (round.optionPoolPct > 0 && round.optionPoolTiming === 'post') {
                        optionPoolShares = (round.optionPoolPct / 100) * postMoneyShares;
                        shareholders['Option Pool'].shares += optionPoolShares;
                        postMoneyShares += optionPoolShares;
                    }

                    totalShares = postMoneyShares;
                    const postMoneyValuation = round.preMoneyValuation + round.investment;
                    const ownership = {};
                    Object.keys(shareholders).forEach(name => { ownership[name] = (shareholders[name].shares / totalShares) * 100; });
                    history.push({ stage: round.name, totalShares, sharePrice, postMoneyValuation, investment: round.investment, shareholders: JSON.parse(JSON.stringify(shareholders)), ownership: { ...ownership }, roundDetails: { optionPoolPct: round.optionPoolPct, optionPoolTiming: round.optionPoolTiming, optionPoolShares, liquidationPreference: round.liquidationPreference, participating: round.participating, antiDilution: round.antiDilution } });
                });
                return history;
            }, [foundingShares, rounds]);

            const liquidationAnalysis = useMemo(() => {
                if (rounds.length === 0) return null;
                const currentData = capTableData[capTableData.length - 1];
                const proceeds = exitValuation;
                const distribution = {};
                let remainingProceeds = proceeds;
                Object.keys(currentData.shareholders).forEach(name => { distribution[name] = 0; });

                const preferredHolders = Object.keys(currentData.shareholders).filter(name => currentData.shareholders[name].class === 'Preferred').sort((a, b) => rounds.findIndex(r => r.name === b) - rounds.findIndex(r => r.name === a));

                preferredHolders.forEach(name => {
                    const shareholder = currentData.shareholders[name];
                    const liquidationAmount = shareholder.invested * (shareholder.preferences.liquidationPreference || 1);
                    if (remainingProceeds >= liquidationAmount) { distribution[name] += liquidationAmount; remainingProceeds -= liquidationAmount; }
                    else { distribution[name] += remainingProceeds; remainingProceeds = 0; }
                });

                const participatingHolders = preferredHolders.filter(name => currentData.shareholders[name].preferences.participating);
                if (participatingHolders.length > 0 && remainingProceeds > 0) {
                    const participatingShares = participatingHolders.reduce((sum, name) => sum + currentData.shareholders[name].shares, 0);
                    const commonShares = currentData.shareholders['Founders']?.shares || 0;
                    const totalParticipatingShares = participatingShares + commonShares;
                    const proRataDistribution = remainingProceeds;

                    participatingHolders.forEach(name => {
                        const shareholder = currentData.shareholders[name];
                        const proRataShare = (shareholder.shares / totalParticipatingShares) * proRataDistribution;
                        const cap = shareholder.preferences.participationCap * shareholder.invested;
                        const additionalAmount = Math.min(proRataShare, cap - distribution[name]);
                        if (additionalAmount > 0) { distribution[name] += additionalAmount; remainingProceeds -= additionalAmount; }
                    });
                    if (currentData.shareholders['Founders']) {
                        const founderProRata = (commonShares / totalParticipatingShares) * proRataDistribution;
                        distribution['Founders'] += Math.min(founderProRata, remainingProceeds);
                        remainingProceeds -= Math.min(founderProRata, remainingProceeds);
                    }
                } else {
                    const commonShares = (currentData.shareholders['Founders']?.shares || 0) + (currentData.shareholders['Option Pool']?.shares || 0);
                    if (commonShares > 0 && remainingProceeds > 0) {
                        distribution['Founders'] = (distribution['Founders'] || 0) + (remainingProceeds * (currentData.shareholders['Founders']?.shares || 0) / commonShares);
                        distribution['Option Pool'] = (distribution['Option Pool'] || 0) + (remainingProceeds * (currentData.shareholders['Option Pool']?.shares || 0) / commonShares);
                    }
                }

                const analysis = {};
                Object.keys(distribution).forEach(name => {
                    const shareholder = currentData.shareholders[name];
                    analysis[name] = { proceeds: distribution[name], invested: shareholder.invested || 0, multiple: shareholder.invested > 0 ? distribution[name] / shareholder.invested : 0, percentOfTotal: (distribution[name] / proceeds) * 100 };
                });
                return analysis;
            }, [capTableData, rounds, exitValuation]);

            const ownershipChartData = useMemo(() => capTableData.map(entry => { const data = { stage: entry.stage }; Object.keys(entry.ownership).forEach(sh => { data[sh] = entry.ownership[sh].toFixed(2); }); return data; }), [capTableData]);
            const valuationChartData = useMemo(() => capTableData.map(entry => ({ stage: entry.stage, 'Share Price': entry.sharePrice ? entry.sharePrice.toFixed(4) : 0, 'Post-Money Valuation': entry.postMoneyValuation / 1000000 })), [capTableData]);
            const allShareholders = useMemo(() => capTableData.length === 0 ? [] : Object.keys(capTableData[capTableData.length - 1].shareholders), [capTableData]);
            const shareholderColors = { 'Founders': '#4a9eff', 'Option Pool': '#a855f7', 'Pre-Seed': '#00d4aa', 'Seed': '#ffa726', 'Series A': '#ff5757', 'Series B': '#ec4899', 'Series C': '#06b6d4', 'Series D': '#84cc16' };
            const formatCurrency = (value) => { if (value >= 1000000) return `$${(value / 1000000).toFixed(2)}M`; if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`; return `$${value.toFixed(0)}`; };
            const currentData = capTableData[capTableData.length - 1];

            return (
                <div className="app-container">
                    {showAddModal && (
                        <div className="modal-overlay" onClick={closeModal}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">{editingIndex !== null ? 'Edit Round' : 'Add New Round'}</h2>
                                    <button className="btn btn-danger" onClick={closeModal}>✕</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-group">
                                        <label className="form-label">Round Name *</label>
                                        <input type="text" className="form-input" value={newRound.name} onChange={(e) => setNewRound({...newRound, name: e.target.value})} placeholder="e.g., Seed, Series A" />
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Investment Amount ($) *</label>
                                            <input type="number" className="form-input" value={newRound.investment} onChange={(e) => setNewRound({...newRound, investment: Number(e.target.value)})} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Pre-Money Valuation ($) *</label>
                                            <input type="number" className="form-input" value={newRound.preMoneyValuation} onChange={(e) => setNewRound({...newRound, preMoneyValuation: Number(e.target.value)})} />
                                        </div>
                                    </div>
                                    <div className="hint" style={{marginBottom: '16px'}}>
                                        Post-Money: <strong>{formatCurrency(newRound.preMoneyValuation + newRound.investment)}</strong> • Investor Ownership: <strong>{((newRound.investment / (newRound.preMoneyValuation + newRound.investment)) * 100 || 0).toFixed(2)}%</strong>
                                    </div>
                                    <div className="section-title">Option Pool</div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Pool Size (%)</label>
                                            <input type="number" className="form-input" value={newRound.optionPoolPct} onChange={(e) => setNewRound({...newRound, optionPoolPct: Number(e.target.value)})} min="0" max="100" step="0.1" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Pool Timing</label>
                                            <select className="form-select" value={newRound.optionPoolTiming} onChange={(e) => setNewRound({...newRound, optionPoolTiming: e.target.value})}>
                                                <option value="pre">Pre-Money (founders diluted)</option>
                                                <option value="post">Post-Money (all diluted)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="section-title">Liquidation Preferences</div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Preference Multiple</label>
                                            <input type="number" className="form-input" value={newRound.liquidationPreference} onChange={(e) => setNewRound({...newRound, liquidationPreference: Number(e.target.value)})} min="1" step="0.1" />
                                            <div className="hint">Typically 1x (returns invested capital first)</div>
                                        </div>
                                        <div className="form-group" style={{display: 'flex', alignItems: 'center', paddingTop: '24px'}}>
                                            <label className="checkbox-label">
                                                <input type="checkbox" checked={newRound.participating} onChange={(e) => setNewRound({...newRound, participating: e.target.checked})} />
                                                Participating Preferred
                                            </label>
                                        </div>
                                    </div>
                                    {newRound.participating && (
                                        <div className="form-group">
                                            <label className="form-label">Participation Cap (multiple)</label>
                                            <input type="number" className="form-input" value={newRound.participationCap} onChange={(e) => setNewRound({...newRound, participationCap: Number(e.target.value)})} min="1" step="0.5" />
                                        </div>
                                    )}
                                    <div className="section-title">Anti-Dilution & Pro-Rata</div>
                                    <div className="form-group">
                                        <label className="form-label">Anti-Dilution Protection</label>
                                        <select className="form-select" value={newRound.antiDilution} onChange={(e) => setNewRound({...newRound, antiDilution: e.target.value})}>
                                            <option value="none">None</option>
                                            <option value="weighted-average">Weighted Average</option>
                                            <option value="full-ratchet">Full Ratchet</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="checkbox-label">
                                            <input type="checkbox" checked={newRound.proRataRights} onChange={(e) => setNewRound({...newRound, proRataRights: e.target.checked})} />
                                            Pro-Rata Rights
                                        </label>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={closeModal}>Cancel</button>
                                    <button className="btn btn-primary" onClick={saveRound}>{editingIndex !== null ? 'Update Round' : 'Add Round'}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="header">
                        <h1>Cap Table Analyzer</h1>
                        <p className="subtitle">Model funding rounds, dilution & exit scenarios</p>
                    </div>

                    {rounds.length > 0 && (
                        <div className="summary-grid">
                            <div className="summary-card purple">
                                <div className="summary-label">Current Stage</div>
                                <div className="summary-value">{currentData.stage}</div>
                                <div className="summary-sub">{formatCurrency(currentData.postMoneyValuation)} valuation</div>
                            </div>
                            <div className="summary-card green">
                                <div className="summary-label">Founder Ownership</div>
                                <div className="summary-value">{currentData.ownership['Founders']?.toFixed(1)}%</div>
                                <div className="summary-sub">Fully diluted basis</div>
                            </div>
                            <div className="summary-card blue">
                                <div className="summary-label">Share Price</div>
                                <div className="summary-value">${currentData.sharePrice?.toFixed(4)}</div>
                                <div className="summary-sub">Current value</div>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <h2 className="card-title">Founding Parameters</h2>
                        <div className="form-group" style={{maxWidth: '300px'}}>
                            <label className="form-label">Founding Shares</label>
                            <input type="number" className="form-input" value={foundingShares} onChange={(e) => setFoundingShares(Number(e.target.value))} />
                        </div>
                    </div>

                    <div className="card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h2 className="card-title" style={{marginBottom: 0}}>Funding Rounds</h2>
                            <button className="btn btn-primary" onClick={openAddModal}>+ Add Round</button>
                        </div>
                        {rounds.length === 0 ? (
                            <div className="empty-state">No funding rounds yet. Click "Add Round" to begin.</div>
                        ) : rounds.map((round, index) => (
                            <div key={index} className="round-item">
                                <div className="round-header">
                                    <div>
                                        <span className="round-name">{round.name}</span>
                                        <button className="btn btn-secondary" style={{marginLeft: '12px', padding: '4px 8px', fontSize: '0.8rem'}} onClick={() => openEditModal(index)}>Edit</button>
                                    </div>
                                    <button className="btn btn-danger" onClick={() => removeRound(index)}>✕</button>
                                </div>
                                <div className="round-details">
                                    <div><span className="round-detail-label">Investment</span><div className="round-detail-value">{formatCurrency(round.investment)}</div></div>
                                    <div><span className="round-detail-label">Pre-Money</span><div className="round-detail-value">{formatCurrency(round.preMoneyValuation)}</div></div>
                                    <div><span className="round-detail-label">Post-Money</span><div className="round-detail-value">{formatCurrency(round.preMoneyValuation + round.investment)}</div></div>
                                    <div><span className="round-detail-label">New Investor</span><div className="round-detail-value">{((round.investment / (round.preMoneyValuation + round.investment)) * 100).toFixed(2)}%</div></div>
                                </div>
                                {(round.optionPoolPct > 0 || round.liquidationPreference > 1 || round.participating || round.antiDilution !== 'none') && (
                                    <div className="tags">
                                        {round.optionPoolPct > 0 && <span className="tag">{round.optionPoolPct}% Pool ({round.optionPoolTiming})</span>}
                                        {round.liquidationPreference > 1 && <span className="tag">{round.liquidationPreference}x Preference</span>}
                                        {round.participating && <span className="tag green">Participating ({round.participationCap}x cap)</span>}
                                        {round.antiDilution !== 'none' && <span className="tag orange">{round.antiDilution === 'full-ratchet' ? 'Full Ratchet' : 'Weighted Avg'}</span>}
                                        {round.proRataRights && <span className="tag gray">Pro-Rata</span>}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {rounds.length > 0 && (
                        <>
                            <div className="card">
                                <h2 className="card-title">Ownership Evolution</h2>
                                <div className="chart-container">
                                    <OwnershipChart data={ownershipChartData} shareholders={allShareholders} colors={shareholderColors} />
                                </div>
                            </div>

                            <div className="card">
                                <h2 className="card-title">Share Price & Valuation Growth</h2>
                                <div className="chart-container">
                                    <ValuationChart data={valuationChartData} />
                                </div>
                            </div>

                            <div className="card">
                                <h2 className="card-title">Current Cap Table</h2>
                                <div style={{overflowX: 'auto'}}>
                                    <table>
                                        <thead><tr><th>Shareholder</th><th className="text-right">Shares</th><th className="text-right">Ownership %</th><th className="text-right">Value</th><th>Class</th></tr></thead>
                                        <tbody>
                                            {Object.entries(currentData.shareholders).sort((a, b) => b[1].shares - a[1].shares).map(([name, data]) => (
                                                <tr key={name}>
                                                    <td style={{fontWeight: 500}}>{name}</td>
                                                    <td className="text-right">{data.shares.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                                                    <td className="text-right">{currentData.ownership[name]?.toFixed(2)}%</td>
                                                    <td className="text-right">{formatCurrency(data.shares * currentData.sharePrice)}</td>
                                                    <td>{data.class}</td>
                                                </tr>
                                            ))}
                                            <tr style={{background: 'var(--bg-tertiary)', fontWeight: 600}}>
                                                <td>Total</td>
                                                <td className="text-right">{currentData.totalShares.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                                                <td className="text-right">100.00%</td>
                                                <td className="text-right">{formatCurrency(currentData.postMoneyValuation)}</td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {liquidationAnalysis && (
                                <div className="card">
                                    <h2 className="card-title">Exit Scenario Modeling</h2>
                                    <p style={{color: 'var(--text-secondary)', marginBottom: '20px'}}>Model how exit proceeds are distributed based on liquidation preferences</p>
                                    <div className="form-group" style={{maxWidth: '400px', marginBottom: '30px'}}>
                                        <label className="form-label">Exit Valuation ($)</label>
                                        <input type="number" className="form-input" value={exitValuation} onChange={(e) => setExitValuation(Number(e.target.value))} />
                                    </div>
                                    <h3 style={{color: 'var(--text-primary)', marginBottom: '16px'}}>Final Distribution</h3>
                                    <div style={{overflowX: 'auto'}}>
                                        <table>
                                            <thead><tr><th>Shareholder</th><th className="text-right">Invested</th><th className="text-right">Proceeds</th><th className="text-right">Return (x)</th><th className="text-right">% of Exit</th></tr></thead>
                                            <tbody>
                                                {Object.entries(liquidationAnalysis).filter(([_, d]) => d.proceeds > 0).sort((a, b) => b[1].proceeds - a[1].proceeds).map(([name, data]) => (
                                                    <tr key={name}>
                                                        <td style={{fontWeight: 500}}>{name}</td>
                                                        <td className="text-right">{data.invested > 0 ? formatCurrency(data.invested) : '-'}</td>
                                                        <td className="text-right" style={{fontWeight: 600}}>{formatCurrency(data.proceeds)}</td>
                                                        <td className="text-right">{data.multiple > 0 ? <span className={data.multiple >= 1 ? 'text-success' : 'text-danger'}>{data.multiple.toFixed(2)}x</span> : '-'}</td>
                                                        <td className="text-right">{data.percentOfTotal.toFixed(1)}%</td>
                                                    </tr>
                                                ))}
                                                <tr style={{background: 'var(--bg-tertiary)', fontWeight: 600}}>
                                                    <td>Total</td>
                                                    <td className="text-right">{formatCurrency(Object.values(liquidationAnalysis).reduce((sum, d) => sum + d.invested, 0))}</td>
                                                    <td className="text-right">{formatCurrency(exitValuation)}</td>
                                                    <td className="text-right">{(exitValuation / Math.max(1, Object.values(liquidationAnalysis).reduce((sum, d) => sum + d.invested, 0))).toFixed(2)}x</td>
                                                    <td className="text-right">100.0%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="info-box">
                                        <div className="info-box-title">Understanding Liquidation Preferences</div>
                                        <p><strong>Non-participating preferred:</strong> Investors choose between liquidation preference OR converting to common.</p>
                                        <p><strong>Participating preferred:</strong> Investors get liquidation preference first, THEN participate pro-rata (up to cap).</p>
                                    </div>
                                </div>
                            )}

                            <div className="insights">
                                <div className="insights-title">Key Insights</div>
                                <ul>
                                    <li>Founders started with 100% and now own {currentData.ownership['Founders']?.toFixed(1)}% after {rounds.length} round{rounds.length > 1 ? 's' : ''}</li>
                                    <li>Total dilution: {(100 - currentData.ownership['Founders']).toFixed(1)} percentage points</li>
                                    <li>Share price: {capTableData[1]?.sharePrice > 0 ? `${(currentData.sharePrice / capTableData[1].sharePrice).toFixed(1)}x` : 'N/A'} from first round</li>
                                    <li>Company valuation: {formatCurrency(currentData.postMoneyValuation)}</li>
                                    {liquidationAnalysis && <li>At {formatCurrency(exitValuation)} exit, founders receive {formatCurrency(liquidationAnalysis['Founders']?.proceeds || 0)} ({(liquidationAnalysis['Founders']?.percentOfTotal || 0).toFixed(1)}%)</li>}
                                </ul>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CapTableTool />);
    </script>
</body>
</html>
